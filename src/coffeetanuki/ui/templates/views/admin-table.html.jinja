{% extends "base/base.html.jinja" %}

{% block title %}{{ table_name|capitalize }} Table - Admin{% endblock %}

{% block header %}{% include "base/admin-header.html.jinja" %}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bulma.min.css" />
{% endblock %}

{% block head_scripts %}
<script src="//code.iconify.design/1/1.0.6/iconify.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bulma.min.js"></script>
{% endblock %}

{% block content %}
<main class="site-content">
  <section class="section">
    <div class="container">
      <h1 class="is-size-1 title">
        {{ table_name|capitalize }}
      </h1>
      <table id="table" class="table is-striped is-hoverable is-fullwidth">
        <thead>
          <tr>
            {% for col in cols %}
            <th>{{ col }}</th>
            {% endfor %}
            <th class="no-sort">actions</th>
          </tr>
        </thead>
        <tbody>
          {% for row in data %}
          <tr>
            {% for col in cols %}
            <td class="is-nowrap">
              {% if col in ["description"] and row[col] %}
              {{ "..." }}
              {% elif "." in col %}
              {% set a, n = col.split(".") %}
              {{ row[a][n] }}
              {% else %}
              {{ row[col] }}
              {% endif %}
            </td>
            {% endfor %}
            <td>
              <div class="buttons is-flex is-flex-wrap-nowrap is-right">
                <a href="/{{ table_name }}/{{row['id']}}" class="button is-link is-small">
                  <span class="icon iconify" data-icon="mdi-eye"></span>
                </a>
                <a href="/admin/{{table_name}}/{{row['id']}}/edit" class="button is-primary is-small">
                  <span class="icon iconify" data-icon="mdi-pencil"></span>
                </a>
                <a href="#" data-item-id="{{row['id']}}" class="button is-danger is-small delete-button">
                  <span class="icon iconify" data-icon="mdi-delete"></span>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</main>
{% endblock %}

{% block body_scripts %}
<script>
  $(document).ready(function () {
    var dataTable = $('table').DataTable({
      searching: true,     // Enable search functionality
      ordering: true,      // Enable sorting by header
      lengthChange: true,  // Enable max rows per page selector
      paging: true,        // Enable pagination
      autoWidth: false,
      columnDefs: [
        {targets: 'no-sort', orderable: false}  // Disable sorting for columns with no-sort class
      ]
    });
    $('.delete-button').on('click', function (e) {
      e.preventDefault();
      var deleteButton = $(this);
      var itemId = deleteButton.data('item-id');
      var confirmation = confirm('Are you sure you want to delete this item?');

      if (confirmation) {
        // Send a DELETE request using AJAX
        $.ajax({
          url: '/api/shops/' + itemId,
          type: 'DELETE',
          success: function (result) {
            // Handle the success case, e.g., remove the item row from the table
            var row = deleteButton.closest('tr');
            dataTable.row(row).remove().draw();
          },
          error: function (xhr, status, error) {
            // Handle the error case
            console.error(error);
          }
        });
      }
    });
  });
</script>
{% endblock %}
